{% extends "templates/web.html" %}

{% block page_content %}
<div class="container mt-4">
  <div class="row align-items-center">
    <div class="col-md-8">
      <h1 class="mb-1">Due Diligence</h1>
      <p class="text-muted mb-0">Pull public-facing details (starting with staff directories) to speed up onboarding.</p>
    </div>
    <div class="col-md-4 text-md-right mt-3 mt-md-0">
      {% if hths_project_url %}
        <a class="btn btn-outline-secondary" href="{{ hths_project_url }}">HTHS AD Project</a>
      {% endif %}
    </div>
  </div>

  <div class="card mt-4">
    <div class="card-body">
      <div class="h5 mb-3">Staff directory pull</div>
      <div class="form-row">
        <div class="form-group col-md-9">
          <label for="dd-staff-url" class="small text-muted mb-1">Staff page URL</label>
          <input id="dd-staff-url" class="form-control" type="url" value="{{ default_staff_url }}" />
        </div>
        <div class="form-group col-md-3 d-flex align-items-end">
          <button id="dd-fetch-staff" class="btn btn-primary btn-block">Fetch</button>
        </div>
      </div>

      <div class="d-flex align-items-center justify-content-between mt-2">
        <div id="dd-staff-count" class="text-muted small"></div>
        <button id="dd-export-csv" class="btn btn-sm btn-outline-secondary" disabled>Export CSV</button>
      </div>

      <div id="dd-result" class="mt-3"></div>

      <div class="table-responsive mt-3">
        <table class="table table-sm table-striped mb-0">
          <thead>
            <tr>
              <th>Name</th>
              <th>Title</th>
              <th>Email</th>
            </tr>
          </thead>
          <tbody id="dd-staff-table"></tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<script>
  (function () {
    var currentStaff = [];

    function escapeHtml(text) {
      return (text || "").replace(/[&<>"']/g, function (c) {
        return {"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#039;"}[c];
      });
    }

    function setResult(html) {
      var el = document.getElementById("dd-result");
      if (el) el.innerHTML = html || "";
    }

    function setCount(count) {
      var el = document.getElementById("dd-staff-count");
      if (!el) return;
      if (typeof count === "number") {
        el.textContent = "Found " + count + " staff entries";
      } else {
        el.textContent = "";
      }
    }

    function renderTable(staff) {
      var tbody = document.getElementById("dd-staff-table");
      if (!tbody) return;
      tbody.innerHTML = "";
      (staff || []).forEach(function (row) {
        var tr = document.createElement("tr");
        tr.innerHTML =
          "<td>" + escapeHtml(row.full_name || "") + "</td>" +
          "<td>" + escapeHtml(row.title || "") + "</td>" +
          "<td>" + escapeHtml(row.email || "") + "</td>";
        tbody.appendChild(tr);
      });
    }

    function toCsvValue(value) {
      var s = (value == null) ? "" : String(value);
      s = s.replace(/"/g, '""');
      return '"' + s + '"';
    }

    function exportCsv(staff) {
      var lines = [];
      lines.push(["full_name", "title", "email", "source_url"].map(toCsvValue).join(","));
      (staff || []).forEach(function (row) {
        lines.push(
          [
            row.full_name || "",
            row.title || "",
            row.email || "",
            row.source_url || "",
          ].map(toCsvValue).join(",")
        );
      });

      var blob = new Blob([lines.join("\n") + "\n"], {type: "text/csv;charset=utf-8"});
      var url = URL.createObjectURL(blob);
      var a = document.createElement("a");
      a.href = url;
      a.download = "staff-directory.csv";
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    frappe.ready(function () {
      var btn = document.getElementById("dd-fetch-staff");
      var exportBtn = document.getElementById("dd-export-csv");
      var urlInput = document.getElementById("dd-staff-url");
      if (!btn || !exportBtn || !urlInput) return;

      exportBtn.addEventListener("click", function () {
        if (!currentStaff.length) return;
        exportCsv(currentStaff);
      });

      btn.addEventListener("click", function () {
        var url = (urlInput.value || "").trim();
        if (!url) return;

        btn.disabled = true;
        exportBtn.disabled = true;
        currentStaff = [];
        setCount(null);
        renderTable([]);
        setResult("");

        frappe.call({
          method: "ftg_lead_radar.api.scrape_staff_directory",
          args: {url: url},
          callback: function (r) {
            var msg = (r && r.message) ? r.message : {};
            var staff = msg.staff || [];
            currentStaff = staff;
            setCount(msg.count || staff.length || 0);
            renderTable(staff);
            exportBtn.disabled = !staff.length;
            setResult('<div class="alert alert-success mb-0">Fetched staff directory.</div>');
          },
          error: function (err) {
            var text = (err && err.message) ? err.message : "Fetch failed.";
            setResult('<div class="alert alert-danger mb-0">' + escapeHtml(text) + "</div>");
          },
          always: function () {
            btn.disabled = false;
          },
        });
      });
    });
  })();
</script>
{% endblock %}

